<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- Viewport 標籤是確保在手機 (如 iPhone) 上正確縮放的關鍵 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMO 測試操作流程與記錄</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            /* 移除在 iPhone 上點擊元素時的灰色反白，提升體驗 */
            -webkit-tap-highlight-color: transparent;
        }
        .has-submenu > .menu-item-span {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .has-submenu > .menu-item-span::after {
            content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            opacity: 0.6;
            transition: transform 0.2s ease-in-out;
        }
        .has-submenu.open > .menu-item-span::after {
            transform: rotate(-180deg);
        }
        .level-3.active > span {
            background-color: #ecfeff;
            color: #0e7490;
            font-weight: 500;
        }
        .level-3.completed > span::after {
            content: '✅';
            margin-left: 8px;
            font-size: 0.8em;
        }
        .result-btn.selected {
            background-color: #0891b2; /* Cyan 600 */
            color: white;
            border-color: #0891b2;
        }
        /* 篩選按鈕樣式 */
        .filter-btn.active {
            background-color: #cffafe; /* Cyan 100 */
            color: #0e7490; /* Cyan 800 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-left mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900">LMO 測試操作流程與記錄</h1>
            <p class="text-slate-500 mt-1">請依序點擊測試項目，再進行測試，並可查看匯總報告</p>
        </header>

        <div class="flex flex-col gap-6">
            
            <!-- 上半部：左右結構 -->
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左欄：測試階層 -->
                <div class="w-full lg:w-4/12">
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm h-full">
                         <h2 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">測試階層</h2>
                        <nav>
                            <ul id="menu" class="space-y-1 max-h-[60vh] overflow-y-auto">
                                <!-- Unit 項目將由 JavaScript 動態生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- 右欄：測試畫面 -->
                <div class="w-full lg:w-8/12">
                     <main class="bg-white p-6 md:p-8 rounded-lg border border-slate-200 shadow-sm min-h-[50vh] flex items-center justify-center h-full">
                        <div id="display-area" class="text-center w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" />
                            </svg>
                            <p class="mt-4 text-lg font-medium text-slate-500">尚未選擇測試項目</p>
                            <p class="text-sm text-slate-400">請從左側選單選擇一個項目開始測試</p>
                        </div>
                    </main>
                </div>
            </div>

            <!-- 下半部：匯總報告 -->
            <div class="w-full">
                <aside class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-3 border-b pb-2 gap-2">
                        <h2 class="text-lg font-bold text-slate-800">匯總報告</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <div id="report-filter" class="flex items-center gap-2">
                                <button class="filter-btn active text-sm px-3 py-1 rounded-full bg-slate-100 hover:bg-slate-200" data-filter="all">全部</button>
                                <button class="filter-btn text-sm px-3 py-1 rounded-full bg-slate-100 hover:bg-slate-200" data-filter="陽性">陽性</button>
                                <button class="filter-btn text-sm px-3 py-1 rounded-full bg-slate-100 hover:bg-slate-200" data-filter="陰性">陰性</button>
                            </div>
                            <button id="export-report-btn" class="text-sm px-3 py-1 rounded-full bg-cyan-600 text-white hover:bg-cyan-700 transition-colors">匯出報告</button>
                        </div>
                    </div>
                    <div id="report-container" class="max-h-[40vh] overflow-y-auto text-sm">
                        <!-- 報告內容將由 JS 動態生成 -->
                    </div>
                    <div id="report-summary" class="mt-4 pt-4 border-t">
                        <!-- 合計資料將由 JS 動態生成 -->
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <p class="text-center text-sm text-slate-400 font-semibold tracking-wider">LMO</p>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const menuContainer = document.getElementById('menu');
            const displayArea = document.getElementById('display-area');
            const reportContainer = document.getElementById('report-container');
            const reportFilter = document.getElementById('report-filter');
            const reportSummary = document.getElementById('report-summary');
            const exportBtn = document.getElementById('export-report-btn');
            let activeElement = null;
            const testResults = {};
            let currentFilter = 'all'; // 'all', '陽性', '陰性'

            // 定義菜單數據結構
            const menuData = {};
            for (let i = 1; i <= 8; i++) {
                let unitTitle;
                if (i === 1) unitTitle = 'Unit 1 - OVP 軸';
                else if (i === 2) unitTitle = 'Unit 2 - 胸廓';
                else if (i === 3) unitTitle = 'Unit 3 - 四肢';
                else if (i === 4) unitTitle = 'Unit 4 - 骨內力線';
                else if (i === 5) unitTitle = 'Unit 5 - 頭顱';
                else if (i === 6) unitTitle = 'Unit 6 - 內臟';
                else if (i === 7) unitTitle = 'Unit 7 - 血管系統';
                else if (i === 8) unitTitle = 'Unit 8 - 週邊神經系統';
                
                if (i === 1) {
                    menuData[unitTitle] = {
                        '1st - 脊椎硬膜（後頭） to C7': ['脊椎硬膜（後頭）', ...Array.from({ length: 8 }, (_, j) => `C${j}`)],
                        '2nd - from T1 to ilia': [
                            ...Array.from({ length: 12 }, (_, j) => `T${j + 1}`),
                            ...Array.from({ length: 5 }, (_, j) => `L${j + 1}`),
                            ...Array.from({ length: 5 }, (_, j) => `S${j + 1}`),
                            '薦髂關節'
                        ],
                        '3rd - from the sacrum to the ischia': [
                            '薦髂關節（薦椎）', '脊椎硬膜（薦椎）', '終絲', '尾骨', '坐骨'
                        ]
                    };
                } else if (i === 2) {
                    menuData[unitTitle] = {
                        '1st - 後面胸廓': [
                            ...Array.from({ length: 12 }, (_, j) => `R${j + 1}`),
                            '後橫膈膜腳',
                            '肩胛骨'
                        ],
                        '2nd - 前面胸廓': [
                            ...Array.from({ length: 6 }, (_, j) => `St${j + 1}`),
                            '右鎖骨',
                            '左鎖骨',
                            ...Array.from({ length: 10 }, (_, j) => `右K${j + 1}`),
                            ...Array.from({ length: 10 }, (_, j) => `左K${j + 1}`)
                        ]
                    };
                } else {
                    menuData[unitTitle] = {}; // Units 3-8 have no sub-levels
                }
            }

            // 根據數據動態生成菜單 HTML
            let menuHtml = '';
            for (const unitTitle in menuData) {
                const sequences = menuData[unitTitle];
                const hasSubmenu = Object.keys(sequences).length > 0;
                menuHtml += `<li class="level-1 ${hasSubmenu ? 'has-submenu' : ''}" data-unit="${unitTitle}">
                                <span class="menu-item-span cursor-pointer font-semibold text-slate-700 hover:text-cyan-600 p-2 rounded-md">${unitTitle}</span>`;
                if (hasSubmenu) {
                    menuHtml += `<ul class="pl-4 mt-1 space-y-1 hidden">`;
                    for (const seqTitle in sequences) {
                        menuHtml += `<li class="level-2 has-submenu" data-sequence="${seqTitle}"><span class="menu-item-span cursor-pointer font-medium text-slate-600 hover:text-cyan-600 p-2 rounded-md">${seqTitle}</span><ul class="pl-4 mt-1 space-y-1 hidden">`;
                        sequences[seqTitle].forEach(item => {
                            menuHtml += `<li class="level-3" data-item="${item}"><span class="cursor-pointer flex justify-between items-center py-1.5 px-2 rounded-md hover:bg-slate-100 text-slate-500">${item}</span></li>`;
                        });
                        menuHtml += `</ul></li>`;
                    }
                    menuHtml += `</ul>`;
                }
                menuHtml += `</li>`;
            }
            menuContainer.innerHTML = menuHtml;
            
            const nameMapping = {
                '脊椎硬膜（後頭）': '脊椎硬膜 (Spinal Dura Mater)',
                '脊椎硬膜（薦椎）': '脊椎硬膜 (Spinal Dura Mater)',
                '脊椎硬膜': '脊椎硬膜 (Spinal Dura Mater)',
                '薦髂關節（薦椎）': '薦髂關節 (Sacroiliac Joint)',
                '薦髂關節': '薦髂關節 (Sacroiliac Joint)',
                '終絲': '終絲 (Filum Terminale)',
                '尾骨': '尾骨 (Coccyx)',
                '坐骨': '坐骨 (Ischium)',
                '胸骨': '胸骨 (Sternum)',
                '肋骨': '肋骨 (Ribs)',
                '後橫膈膜腳': '後橫膈膜腳 (Posterior Diaphragmatic Crus)',
                '肩胛骨': '肩胛骨 (Scapula)',
                '右鎖骨': '右鎖骨 (Right Clavicle)',
                '左鎖骨': '左鎖骨 (Left Clavicle)',
                'C': '頸椎 (Cervical Vertebrae)',
                'T': '胸椎 (Thoracic Vertebrae)',
                'L': '腰椎 (Lumbar Vertebrae)',
                'S': '薦椎 (Sacral Vertebrae)',
                'R': '肋骨 (Rib)',
                'St': '胸骨節 (Sternebrae)',
                '右K': '右肋軟骨 (Right Costal Cartilage)',
                '左K': '左肋軟骨 (Left Costal Cartilage)'
            };

            // 更新報告和合計的函數
            function updateReport() {
                const allTestedItems = Object.keys(testResults);
                
                const filteredItems = allTestedItems.filter(item => {
                    if (currentFilter === 'all') return true;
                    return testResults[item].result === currentFilter;
                });

                // 將篩選後的項目組織成階層結構
                const reportData = {};
                filteredItems.forEach(item => {
                    const data = testResults[item];
                    if (!reportData[data.unit]) {
                        reportData[data.unit] = {};
                    }
                    if (!reportData[data.unit][data.sequence]) {
                        reportData[data.unit][data.sequence] = [];
                    }
                    reportData[data.unit][data.sequence].push({ name: item, result: data.result });
                });


                if (Object.keys(reportData).length === 0) {
                    reportContainer.innerHTML = `<p class="text-sm text-slate-500 text-center p-4">沒有符合「${currentFilter}」篩選條件的結果。</p>`;
                } else {
                    let html = '<ul class="space-y-1">';
                    for (const unit in reportData) {
                        html += `<li class="report-level-1 has-submenu open"><span class="menu-item-span cursor-pointer font-semibold text-slate-700 p-1 rounded-md hover:bg-slate-100">${unit}</span>`;
                        html += '<ul class="pl-4 mt-1 space-y-1">';
                        for (const sequence in reportData[unit]) {
                            html += `<li class="report-level-2 has-submenu open"><span class="menu-item-span cursor-pointer font-medium text-slate-600 p-1 rounded-md hover:bg-slate-100">${sequence}</span>`;
                            html += '<ul class="pl-4 mt-1 space-y-1">';
                            reportData[unit][sequence].forEach(itemData => {
                                html += `<li class="report-level-3 flex justify-between items-center py-1 px-2">
                                            <span class="text-slate-800">${itemData.name}</span>
                                            <span class="font-bold ${itemData.result === '陽性' ? 'text-red-500' : 'text-green-600'}">${itemData.result}</span>
                                         </li>`;
                            });
                            html += '</ul></li>';
                        }
                        html += '</ul></li>';
                    }
                    html += '</ul>';
                    reportContainer.innerHTML = html;
                }

                // 更新合計資料
                const positiveCount = allTestedItems.filter(item => testResults[item].result === '陽性').length;
                const negativeCount = allTestedItems.filter(item => testResults[item].result === '陰性').length;
                const totalCount = allTestedItems.length;

                reportSummary.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-slate-500">陽性</p>
                            <p class="text-2xl font-bold text-red-500">${positiveCount}</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">陰性</p>
                            <p class="text-2xl font-bold text-green-600">${negativeCount}</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">總計</p>
                            <p class="text-2xl font-bold text-slate-800">${totalCount}</p>
                        </div>
                    </div>
                `;
            }

            // 報告區塊的收合事件
            reportContainer.addEventListener('click', function (e) {
                const targetSpan = e.target.closest('span.menu-item-span');
                if (!targetSpan) return;
                
                const parentLi = targetSpan.closest('li.has-submenu');
                if (!parentLi) return;

                parentLi.classList.toggle('open');
                const submenu = parentLi.querySelector('ul');
                if (submenu) {
                    submenu.classList.toggle('hidden');
                }
            });

            // 篩選按鈕事件
            reportFilter.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateReport();
                }
            });

            // 匯出報告事件
            exportBtn.addEventListener('click', function() {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM
                csvContent += "Unit,Sequence,項目,結果\r\n";

                for (const itemName in testResults) {
                    const data = testResults[itemName];
                    const row = `"${data.unit}","${data.sequence}","${itemName}","${data.result}"`;
                    csvContent += row + "\r\n";
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "LMO_Report.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // 主選單點擊事件
            menuContainer.addEventListener('click', function (e) {
                const targetSpan = e.target.closest('span');
                if (!targetSpan) return;
                
                const parentLi = targetSpan.closest('li');
                if (!parentLi) return;

                if (parentLi.classList.contains('has-submenu')) {
                    parentLi.classList.toggle('open');
                    const submenu = parentLi.querySelector('ul');
                    if (submenu) {
                       submenu.classList.toggle('hidden');
                    }
                }

                if (parentLi.classList.contains('level-3')) {
                    const itemName = parentLi.dataset.item;
                    const sequenceEl = parentLi.closest('.level-2');
                    const unitEl = parentLi.closest('.level-1');
                    const sequenceName = sequenceEl ? sequenceEl.dataset.sequence : 'N/A';
                    const unitName = unitEl ? unitEl.dataset.unit : 'N/A';

                    let fullName = nameMapping[itemName] || nameMapping[itemName.replace(/\d+/g, '')] || '未知部位';
                    
                    if (activeElement) activeElement.classList.remove('active');
                    parentLi.classList.add('active');
                    activeElement = parentLi;

                    displayArea.innerHTML = `
                        <div class="text-left w-full">
                            <div class="mb-4">
                                <span class="inline-block bg-cyan-100 text-cyan-800 text-sm font-semibold px-3 py-1 rounded-full">${itemName}</span>
                                <h2 class="text-3xl font-bold text-slate-800 mt-3">${fullName}</h2>
                                <p class="text-sm text-slate-500">${unitName} / ${sequenceName}</p>
                            </div>
                            <img src="https://placehold.co/600x300/e2e8f0/64748b?text=Test+Image+for+${itemName}" alt="測試示意圖" class="w-full rounded-lg mb-4 object-cover shadow-md">
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <button class="result-btn border-2 border-slate-300 text-slate-600 font-bold py-3 rounded-lg hover:bg-slate-100 transition" data-item="${itemName}" data-result="陰性">陰性</button>
                                <button class="result-btn border-2 border-slate-300 text-slate-600 font-bold py-3 rounded-lg hover:bg-slate-100 transition" data-item="${itemName}" data-result="陽性">陽性</button>
                            </div>
                        </div>
                    `;
                    if(testResults[itemName]) {
                        const selectedBtn = displayArea.querySelector(`.result-btn[data-result="${testResults[itemName].result}"]`);
                        if(selectedBtn) selectedBtn.classList.add('selected');
                    }
                }
            });

            // 測試結果按鈕點擊事件
            displayArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('result-btn') && activeElement) {
                    const button = e.target;
                    const itemName = button.dataset.item;
                    const result = button.dataset.result;
                    
                    const sequenceEl = activeElement.closest('.level-2');
                    const unitEl = activeElement.closest('.level-1');
                    const sequenceName = sequenceEl ? sequenceEl.dataset.sequence : 'N/A';
                    const unitName = unitEl ? unitEl.dataset.unit : 'N/A';

                    testResults[itemName] = {
                        result: result,
                        unit: unitName,
                        sequence: sequenceName
                    };
                    
                    activeElement.classList.add('completed');
                    
                    const buttons = displayArea.querySelectorAll(`.result-btn[data-item="${itemName}"]`);
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');

                    updateReport();
                }
            });

            // 初始化報告區
            updateReport();
        });
    </script>

</body>
</html>